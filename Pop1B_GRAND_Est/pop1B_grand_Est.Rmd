---
title: "Population du grand est"
author: "JcB"
date: "20/01/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

CE  papier étudie la population du grand est. Source des donées: INSEE
/Users/jean-claudebartier/Documents/Demographie/INSEE_2013/BTX_TD_POP1B_2013.xls
Ce fichier, volumineux (40Mo) comporte les communes françaises avec le nombre d'habitants par sexe et age

Les bases tableaux détaillés 2012 et 2013 sont disponibles dans la rubrique Statistiques en sélectionnant les critères suivants :

thèmes : Démographie > Évolution et structure de la population
Niveau géographique : Toutes les communes
catégories : Données > Bases de données

Vous pouvez aussi accéder directement [à cette sélection](https://www.insee.fr/fr/statistiques?debut=0&idprec=2521169&theme=1&categorie=3&geo=TOUTES_COMMUNE-1).
Le fichier POP1B- Population par sexe et âge est disponible dans la base "Population est résidence antérieure". 

Description Wkipedia de a nouvelle région:
https://fr.wikipedia.org/wiki/Grand_Est

Récupération des données
========================
```{r}
# faire de la place
# rm(list=ls(all=TRUE))

# La commande fread est incroyablement plus rapide que read.csv
# install.packages("OpenMPController")
library("OpenMPController")
library(data.table)
source("../Carto_utilitaires.R")

path <- "/Users/jean-claudebartier/Documents/Demographie/INSEE_2013/BTX_TD_POP1B_2013.csv"
d <- fread(path, skip = 10)
```

Données GE
----------
Le GE comporte 10 départements:

- Ardennes           08
- Aube               10
- Marne              51
- Haute Marne        52
- Meurthe et Moselle 54
- Meuse              55
- Moselle            57
- Bas-Rhin           67
- HautRhin           68
- Vosges             88

```{r}
region <- c("08", "10","51","52","54","55","57","67","68","88")
# ensemble des communes RGE
com_rge <- d[substr(d$CODGEO, 1, 2) %in% region,]

# La première colonne correspond au code INSEE de la commune
# La seconde colne correspond au nom en clair de la commne
# Les colonnes 3 à 103, correspondent aux hommes de 0 à 100 ans
# Les colonnes de 104 à 204, correspondent aux femmes de 0 à 100 ans 

Merging pour avoir les GHT
==========================
```{r}
# ensemble des communes constituant les GHT de la RGE. Liste transmise par E.Lagille
pathGht <- "/Users/jean-claudebartier/Documents/Resural/Stat Resural/RPU_Doc/RPU_Carto-Pop-Alsace/Cartographie/ght_com.csv"
ght2 <- read.csv(pathGht)
a <- add0(ght2$code_com) # ajoute un 0 devant un Finess trop court
ght2$code_com <- a

# La carte fournie par l'ARS est fausse car le GHT2 englobe les communes des départements 21 et 71 qui ne font pas partie de la région grand est. Il faut donc les éliminer:
ght4 <-ght2[ght2$DEP != 21 & ght2$DEP != 71 ,]
# on met un 0 devant les départements dont le n° est < à 10
x <- add0(ght4$code_com)
ght4$code_com <- x
head(ght4)

# merging
com_rge <- merge(com_rge, ght4, by.x = "CODGEO", by.y = "code_com", all.x = T)
```

# Création de 3 nouveles colonnes vides:
com_rge$h <- NA
com_rge$f <- NA
com_rge$tot <- NA
n <- nrow(com_rge)

# total des hommes
a <- apply(com_rge[,3:103], 1, sum)
# total des femmes
b <- apply(com_rge[,104:204], 1, sum)
com_rge$h <- a
com_rge$f <- b
# total pour la commune
a
b
com_rge$tot <- a + b

# communes "mortes pour la France"
com_rge[which(com_rge$tot == 0), c(1:2,213)]

# communes avec moisns de 50 habitants
com_rge[which(com_rge$tot < 50), c(1:2,213)]

```


Age moyen et age médian par commune
-----------------------------------
Chaque case contient le nombre d'indvidus pour un age donné. Pour calculer un age moyen, il faut multiplier l'age par le nb d'individus

### Age des hommes

```{r age_moyen}

# age moyen hommes pour la commune 1
<!-- a <- com_rge[1, 3:103] # nb d'hommes -->
<!-- b <- a * 0:100 # fois age -->
<!-- c <- sum(b) # somme des ages -->
# b
# age moyen
# c/sum(com_rge[1, 3:103])

n <- nrow(com_rge)

for (i in 1:n) {
      a <- com_rge[i, 3:103] # nb d'hommes  
      b <- a * 0:100 # fois age
      c <- sum(b) # somme des ages
      # age moyen
      com_rge[i, "hMean"] <- c/sum(a)
}
summary(com_rge$hMean)
hist(com_rge$hMean, breaks = 20, main = "Hommes RGE - 2015", col = "cornflowerblue", border = "white", ylab = "Fréquence", xlab = "Age des hommes par commune")

```

### Age des femmes

```{r}

for (i in 1:n) {
      a <- com_rge[i, 104:204] # nb de femmes 
      b <- a * 0:100 # fois age
      c <- sum(b) # somme des ages
      # age moyen
      com_rge[i, "fMean"] <- c/sum(a) # age moyen des femmes dans cette commune
      # com_rge[i, "fMean2"] <- mean(c, na.rm = T)
}
summary(com_rge$fMean)
hist(com_rge$fMean, breaks = 20, main = "Femmes RGE - 2015", col = "pink", border = "white", ylab = "Fréquence", xlab = "Age des femmes par commune")
abline(v = 42.42, lty = 3, col = "red")

```

Nombre de 75 ans et plus
------------------------

- hommes: 3 + 75 à 103 = 78 à 103 (vérification: which(colnames(com_rge) == "SEXE1_AGED100075") = 78
)
- femmes: 104 + 75 à 204 = 179 à 204 (vérif: which(colnames(com_rge) == "SEXE2_AGED100075") = 179
)
```{r}
# total des hommes > ou = à 75 ans
a <- apply(com_rge[,78:103], 1, sum)
# total des femmes > ou = à 75 ans
b <- apply(com_rge[,179:204], 1, sum)

com_rge$hsupouegal75 <- a
com_rge$fsupouegal75 <- b
com_rge$totsupouegal75 <- a + b # total des 2 sexes
com_rge$propsupouegal75 <- com_rge$totsupouegal75 / com_rge$tot # prop des 75 ans et plus
head(com_rge$propsupouegal75)
summary(com_rge$propsupouegal75)

```

Nombre de moins de 18 ans
-------------------------
```{r}
# hommes mineurs
a <- apply(com_rge[, 3:20], 1, sum, na.rm = T)
# femmes mineures
b <- apply(com_rge[, 104:121], 1, sum, na.rm = T) # which(colnames(com_rge) == "SEXE2_AGED100017") et which(colnames(com_rge) == "SEXE2_AGED100000")

com_rge$hMineur <- a
com_rge$fMineur <- b
com_rge$totMineur <- a + b
com_rge$propMineur <- com_rge$totMineur / com_rge$tot
summary(com_rge$propMineur)
# communes sans enfants
x <- which(com_rge$totMineur == 0)
x
for(i in x){
 com_rge$propAdulte[i] = 0.001
}

```

Nombre d'adultes (18 inclus à 74 inclus)
-----------------------------------------
```{r}
# hommes adultes
a <- apply(com_rge[, 21:77], 1, sum) # which(colnames(com_rge) == "SEXE1_AGED100018") et which(colnames(com_rge) == "SEXE1_AGED100074")


# femmes adultes
b <- apply(com_rge[, 122:178], 1, sum) # which(colnames(com_rge) == "SEXE2_AGED100018") et which(colnames(com_rge) == "SEXE2_AGED100074")

com_rge$hAdulte <- a
com_rge$fAdulte <- b
com_rge$totAdulte <- a + b # totalité des adultes pour une commune
com_rge$propAdulte <- com_rge$totAdulte / com_rge$tot
summary(com_rge$propAdulte)

# communes sans adultes
x <- which(com_rge$propAdulte == "NaN")
x

```



cacul en fonction des GHT: 
on e garde que les colonnes avec des résultats
```{r}

a <- com_rge[, 205:228]
names(a)

x <- tapply(as.numeric(a$propsupouegal75), a$GHT, mean)
round(x*100, 2)
```
1     2     3     4     5     6     7     8     9    10    11    12 
8.60  9.00  9.96 12.41 10.07  7.43  8.53  9.91  8.28  8.49  8.19  7.9

cut(x*100,5, labels = brewer.pal(n = 5, name = "Blues"))

```{r}
plot(ght5)
text(coordinates(ght5), as.character(round(x*100, 2)))

coul = cut(x, breaks = 5, labels = brewer.pal(n = 5, name = "Blues"))
plot(ght5, col = as.character(coul), main = "% de 75 ans et plus", axes = TRUE)
text(coordinates(ght5), as.character(round(x*100, 2)))

```

Moins de 18 ans
---------------
```{r}
x <- tapply(as.numeric(com_rge$propMineur), com_rge$GHT, mean)
round(x*100, 2)

coul = cut(x, breaks = 5, labels = brewer.pal(n = 5, name = "Reds"))
plot(ght5, col = as.character(coul), main = "% de 18 ans et moins", axes = TRUE)
text(coordinates(ght5), as.character(round(x*100, 2)))
```

Adultes
--------
```{r}
x <- tapply(as.numeric(com_rge$propAdulte), com_rge$GHT, mean)
round(x*100, 2)

coul = cut(x, breaks = 5, labels = brewer.pal(n = 5, name = "Greens"))
plot(ght5, col = as.character(coul), main = "% de 18 à 75 ans", axes = TRUE)
text(coordinates(ght5), as.character(round(x*100, 2)))

```

